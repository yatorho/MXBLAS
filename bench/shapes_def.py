import copy
from enum import Enum
from typing import Any, Dict, Iterable, List, Optional, Tuple

GEMM_SHAPES = {
    "gpt-neo-1.3B": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 50257),
    ],
    "gpt-neo-2.7B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 50257),
    ],
    "gpt-j-6B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 50257),
    ],
    "gpt-neox-20B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 50432),
    ],
    "palm-8B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 256000),
    ],
    "palm-62B": [
        (8192, 8192),
        (8192, 32768),
        (32768, 8192),
        (8192, 256000),
    ],
    "t5-small": [
        (512, 512),
        (512, 2048),
        (2048, 512),
        (512, 32128),
    ],
    "t5-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 32128),
    ],
    "t5-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 32128),
    ],
    "t5-3B": [
        (1024, 1024),
        (1024, 16384),
        (16384, 1024),
        (1024, 32128),
    ],
    "t5-11B": [
        (1024, 1024),
        (1024, 65536),
        (65536, 1024),
        (1024, 32128),
    ],
    "flan-t5-small": [
        (512, 512),
        (512, 2048),
        (2048, 512),
        (512, 32128),
    ],
    "flan-t5-xl": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32128),
    ],
    "bert-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 30522),
    ],
    "bert-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 30522),
    ],
    "roberta-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 50265),
    ],
    "roberta-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 50265),
    ],
    "electra-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 30522),
    ],
    "electra-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 30522),
    ],
    "albert-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 30000),
    ],
    "albert-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 30000),
    ],
    "albert-xxlarge": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 30000),
    ],
    "xlnet-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 32000),
    ],
    "xlnet-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 32000),
    ],
    "bart-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 50265),
    ],
    "bart-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 50265),
    ],
    "deberta-base": [
        (768, 768),
        (768, 3072),
        (3072, 768),
        (768, 50265),
    ],
    "deberta-large": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 50265),
    ],
    "deberta-v2-xxlarge": [
        (1536, 1536),
        (1536, 6144),
        (6144, 1536),
        (1536, 128000),
    ],
    "bloom-560M": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 250880),
    ],
    "bloom-1.7B": [
        (1536, 1536),
        (1536, 6144),
        (6144, 1536),
        (1536, 250880),
    ],
    "bloom-3B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 250880),
    ],
    "bloom-7.1B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 250880),
    ],
    "opt-350M": [
        (1024, 1024),
        (1024, 4096),
        (4096, 1024),
        (1024, 50272),
    ],
    "opt-1.3B": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 50272),
    ],
    "opt-2.7B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 50272),
    ],
    "opt-6.7B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 50272),
    ],
    "opt-13B": [
        (5120, 5120),
        (5120, 20480),
        (20480, 5120),
        (5120, 50272),
    ],
    "opt-30B": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 50272),
    ],
    "opt-66B": [
        (9216, 9216),
        (9216, 36864),
        (36864, 9216),
        (9216, 50272),
    ],
    "chatglm-6B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 65024),
    ],
    "chatglm2-6B": [
        (4096, 4096),
        (4096, 13696),
        (13696, 4096),
        (4096, 65024),
    ],
    "chatglm3-6B": [
        (4096, 4096),
        (4096, 13696),
        (13696, 4096),
        (4096, 65024),
    ],
    "qwen-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 151936),
    ],
    "qwen-14B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 151936),
    ],
    "qwen-72B": [
        (8192, 8192),
        (8192, 24576),
        (24576, 8192),
        (8192, 151936),
    ],
    "mistral-7B": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "mixtral-8x7B": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "gemini-1.0-pro": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 256000),
    ],
    "gemini-1.5-pro": [
        (12288, 12288),
        (12288, 49152),
        (49152, 12288),
        (12288, 256000),
    ],
    "claude-2.1": [
        (8192, 8192),
        (8192, 32768),
        (32768, 8192),
        (8192, 100257),
    ],
    "claude-3-opus": [
        (12288, 12288),
        (12288, 49152),
        (49152, 12288),
        (12288, 100257),
    ],
    "yi-6B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 64000),
    ],
    "yi-34B": [
        (7168, 7168),
        (7168, 20480),
        (20480, 7168),
        (7168, 64000),
    ],
    "deepseek-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-67B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "phi-2": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 51200),
    ],
    "phi-3": [
        (3072, 3072),
        (3072, 12288),
        (12288, 3072),
        (3072, 51200),
    ],
    "stablelm-3B": [
        (2560, 2560),
        (2560, 6912),
        (6912, 2560),
        (2560, 50304),
    ],
    "stablelm-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 50304),
    ],
    "stablelm-12B": [
        (5120, 5120),
        (5120, 13824),
        (13824, 5120),
        (5120, 50304),
    ],
    "falcon-7B": [
        (4544, 4544),
        (4544, 18176),
        (18176, 4544),
        (4544, 65024),
    ],
    "falcon-40B": [
        (8192, 8192),
        (8192, 32768),
        (32768, 8192),
        (8192, 65024),
    ],
    "falcon-180B": [
        (14848, 14848),
        (14848, 59392),
        (59392, 14848),
        (14848, 65024),
    ],
    "mpt-7B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 50432),
    ],
    "mpt-30B": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 50432),
    ],
    "replit-code-v1.5-3B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 32768),
    ],
    "starcoder-15.5B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 49152),
    ],
    "starcoder2-15B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 49152),
    ],
    "codegen-2.5B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 51200),
    ],
    "codegen-6B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 51200),
    ],
    "codegen-16B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 51200),
    ],
    "codegen2-1B": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 51200),
    ],
    "codegen2-3.7B": [
        (2560, 2560),
        (2560, 10240),
        (10240, 2560),
        (2560, 51200),
    ],
    "codegen2-7B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 51200),
    ],
    "codegen2-16B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 51200),
    ],
    "wizardcoder-15B": [
        (6144, 6144),
        (6144, 24576),
        (24576, 6144),
        (6144, 49152),
    ],
    "wizardlm-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "wizardlm-13B": [
        (5120, 5120),
        (5120, 13824),
        (13824, 5120),
        (5120, 32000),
    ],
    "wizardlm-70B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "openchat-3.5": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "zephyr-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "mistral-7B-instruct": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "command-r": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 100257),
    ],
    "command-r-plus": [
        (12288, 12288),
        (12288, 49152),
        (49152, 12288),
        (12288, 100257),
    ],
    "llama-2-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "llama-2-13B": [
        (5120, 5120),
        (5120, 13824),
        (13824, 5120),
        (5120, 32000),
    ],
    "llama-2-70B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "llama-3-8B": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 128256),
    ],
    "llama-3-70B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 128256),
    ],
    "internlm-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 65024),
    ],
    "internlm-20B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 65024),
    ],
    "baichuan-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 64000),
    ],
    "baichuan-13B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 64000),
    ],
    "aquila-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "aquila-34B": [
        (7168, 7168),
        (7168, 20480),
        (20480, 7168),
        (7168, 32000),
    ],
    "xverse-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "xverse-13B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 32000),
    ],
    "xverse-65B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "skywork-13B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 32000),
    ],
    "skywork-53B": [
        (8192, 8192),
        (8192, 24576),
        (24576, 8192),
        (8192, 32000),
    ],
    "orion-14B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 32000),
    ],
    "orion-34B": [
        (7168, 7168),
        (7168, 20480),
        (20480, 7168),
        (7168, 32000),
    ],
    "orion-70B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "minimax-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "minimax-13B": [
        (5120, 5120),
        (5120, 13696),
        (13696, 5120),
        (5120, 32000),
    ],
    "minimax-70B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-instruct": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-instruct": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-instruct": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-instruct": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-instruct": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-instruct": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-instruct": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-instruct": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-instruct": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-instruct": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-instruct": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-chat": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-chat": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-chat": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-chat": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-chat": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-chat": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-chat": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-chat": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-chat": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-chat": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-chat": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-pretrain": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-pretrain": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-pretrain": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-pretrain": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-pretrain": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-pretrain": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-pretrain": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-pretrain": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-pretrain": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-pretrain": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-pretrain": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-finetune": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-finetune": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-finetune": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-finetune": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-finetune": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-finetune": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-finetune": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-finetune": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-finetune": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-finetune": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-finetune": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-prompt": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-prompt": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-prompt": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-prompt": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-rlhf": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-rlhf": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-rlhf": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-rlhf": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-sft": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-sft": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-sft": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-sft": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-pretrain-sft": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-pretrain-sft": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-pretrain-sft": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-pretrain-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-pretrain-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-pretrain-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-pretrain-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-pretrain-sft": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-pretrain-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-pretrain-sft": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-pretrain-sft": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-pretrain-rlhf": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-pretrain-rlhf": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-pretrain-rlhf": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-pretrain-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-pretrain-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-pretrain-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-pretrain-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-pretrain-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-pretrain-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-pretrain-rlhf": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-pretrain-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-pretrain-sft-rlhf": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-pretrain-sft-rlhf": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-pretrain-sft-rlhf": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-pretrain-sft-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-pretrain-sft-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-pretrain-sft-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-pretrain-sft-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-pretrain-sft-rlhf": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-pretrain-sft-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-pretrain-sft-rlhf": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-pretrain-sft-rlhf": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-coder-1.3B-pretrain-sft-rlhf-prompt": [
        (2048, 2048),
        (2048, 8192),
        (8192, 2048),
        (2048, 32768),
    ],
    "deepseek-coder-6.7B-pretrain-sft-rlhf-prompt": [
        (4096, 4096),
        (4096, 16384),
        (16384, 4096),
        (4096, 32768),
    ],
    "deepseek-coder-33B-pretrain-sft-rlhf-prompt": [
        (7168, 7168),
        (7168, 28672),
        (28672, 7168),
        (7168, 32768),
    ],
    "deepseek-vl-7B-pretrain-sft-rlhf-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-vl-67B-pretrain-sft-rlhf-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-math-7B-pretrain-sft-rlhf-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-math-67B-pretrain-sft-rlhf-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-llm-7B-pretrain-sft-rlhf-prompt": [
        (4096, 4096),
        (4096, 11008),
        (11008, 4096),
        (4096, 32000),
    ],
    "deepseek-llm-67B-pretrain-sft-rlhf-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
    "deepseek-moe-16B-pretrain-sft-rlhf-prompt": [
        (4096, 4096),
        (4096, 14336),
        (14336, 4096),
        (4096, 32000),
    ],
    "deepseek-moe-67B-pretrain-sft-rlhf-prompt": [
        (8192, 8192),
        (8192, 28672),
        (28672, 8192),
        (8192, 32000),
    ],
}


MODEL_NAMES = list(GEMM_SHAPES.keys())
# print(f"Model names: {MODEL_NAMES}")


class ScalingPattern(Enum):
    TT = "TT"  # per-Tensor x per-Tensor
    CC = "CC"  # per-Channel x per-Channel
    BB = "BB"  # per-Block x per-Block
    GG = "GG"  # per-Group x per-Group
    GB = "GB"  # per-Group x per-Block
    TC = "TC"  # per-Tensor x per-Channel
    CT = "CT"  # per-Channel x per-Tensor
    BG = "BG"  # per-Block x per-Group

    def __str__(self):
        return self.value


SP = ScalingPattern


class Method(Enum):
    MXBLAS = "MXBLAS"
    COAT = "COAT"
    DEEP_GEMM = "DEEP_GEMM"
    FB_GEMM = "FB_GEMM"
    CUTLASS = "CUTLASS"
    SG_LANG = "SG_LANG"
    TE_CUBLAS = "TE_CUBLAS"

    def __str__(self):
        return self.value


def method_to_kernel_tag(method: Method) -> Optional[str]:
    assert isinstance(method, Method)
    if method == Method.TE_CUBLAS:
        return "cublas"
    elif method == Method.MXBLAS:
        return "mx_gemm"
    # elif method == Method.DEEP_GEMM:
    #     return "fp8_gemm"
    else:
        return None


# T: per-Tensor
# C: per-Channel
# B: per-Block
# G: per-Group
baselines = {
    Method.COAT: [SP.TT],
    Method.DEEP_GEMM: [SP.GB],
    Method.FB_GEMM: [SP.BB, SP.CC],
    Method.CUTLASS: [SP.TT, SP.BB, SP.GB],
    Method.SG_LANG: [SP.CC, SP.GB],
    Method.TE_CUBLAS: [SP.TT],
}


def sp_to_method(sp: ScalingPattern) -> List[str]:
    methods = []
    for method, patterns in baselines.items():
        if sp in patterns:
            methods.append(method)
    return methods


def gemm_shapes(ms: List[int]) -> Dict[str, List[Tuple[int, int, int]]]:
    gemm_shapes = {}
    for model, keyed_shapes in GEMM_SHAPES.items():
        shapes = []
        for m in ms:
            shapes.extend((m, n, k) for k, n in keyed_shapes)
        gemm_shapes[model] = shapes

    return gemm_shapes


def gen_problem_size(m, n, k, sp: ScalingPattern):
    match sp:
        case SP.TT:
            sm = m
            sn = n
            sk = k
        case SP.CC:
            sm = 1
            sn = 1
            sk = k
        case SP.BB:
            sm = 128 if m > 128 else m
            sn = 128
            sk = 128
        case SP.GG:
            sm = 1
            sn = 1
            sk = 128
        case SP.GB:
            sm = 1
            sn = 128
            sk = 128
        case _:
            raise ValueError(f"Unsupported scaling pattern: {sp}")

    return m, n, k, sm, sn, sk
